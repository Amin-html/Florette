{% extends 'shop/base.html' %}
{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî Florette{% endblock %}

{% block extra_css %}
<style>
.cart-layout { display: grid; grid-template-columns: 1fr 320px; gap: 2rem; align-items: start; }
.cart-item {
    background: white;
    border-radius: 16px;
    padding: 1.3rem;
    display: flex;
    gap: 1.2rem;
    align-items: center;
    box-shadow: var(--shadow);
    margin-bottom: 1rem;
}
.cart-item img { width: 90px; height: 90px; object-fit: cover; border-radius: 12px; flex-shrink: 0; }
.cart-item-emoji { width: 90px; height: 90px; border-radius: 12px; background: var(--accent-light); display:flex;align-items:center;justify-content:center;font-size:2.5rem;flex-shrink:0; }
.cart-item-info { flex: 1; }
.cart-item-name { font-family: 'Inter', sans-serif; font-size: 1.1rem; margin-bottom: 0.3rem; }
.cart-item-price { color: var(--text-muted); font-size: 0.9rem; }
.cart-item-subtotal { color: #2d2d2d; font-weight: 700; font-size: 1.1rem; }
.qty-mini { display:flex;align-items:center;gap:0.5rem;margin:0.5rem 0; }
.qty-mini button { width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:white;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center; }
.qty-mini button:hover { background: var(--accent-light); }
.qty-mini span { font-weight:700;min-width:24px;text-align:center; }
.summary-card { background:white;border-radius:16px;padding:1.5rem;box-shadow:var(--shadow);position:sticky;top:90px; }
.summary-row { display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border); }
.summary-total { display:flex;justify-content:space-between;padding:1rem 0 0;font-size:1.2rem;font-weight:700;color:#2d2d2d; }
.empty-cart { text-align:center;padding:5rem 2rem;color:var(--text-muted); }
@media(max-width:768px) { .cart-layout{grid-template-columns:1fr;} }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
</div>

<section class="section">
<div class="container">

{% if items %}
<div class="cart-layout">
    <div>
        {% for item in items %}
        <div class="cart-item" id="cart-item-{{ item.flower.pk }}">
            {% if item.flower.image %}
                <img src="{{ item.flower.image.url }}" alt="{{ item.flower.name }}">
            {% else %}
                <div class="cart-item-emoji"></div>
            {% endif %}
            <div class="cart-item-info">
                <div class="cart-item-name">{{ item.flower.name }}</div>
                <div class="cart-item-price">{{ item.flower.price }} ‚ÇΩ –∑–∞ —à—Ç.</div>
                <div class="qty-mini">
                    <button onclick="updateQty({{ item.flower.pk }}, -1)">‚àí</button>
                    <span id="qty-{{ item.flower.pk }}">{{ item.qty }}</span>
                    <button onclick="updateQty({{ item.flower.pk }}, 1)">+</button>
                </div>
            </div>
            <div style="text-align:right">
                <div class="cart-item-subtotal" id="sub-{{ item.flower.pk }}">{{ item.subtotal }} ‚ÇΩ</div>
                <button onclick="removeItem({{ item.flower.pk }})" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.2rem;margin-top:0.5rem;">‚úï</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="summary-card">
        <h3 style="font-family:'Inter',sans-serif;margin-bottom:1rem;">–ò—Ç–æ–≥–æ</h3>
        {% for item in items %}
        <div class="summary-row">
            <span style="font-size:0.9rem;">{{ item.flower.name }} √ó {{ item.qty }}</span>
            <span style="font-size:0.9rem;">{{ item.subtotal }} ‚ÇΩ</span>
        </div>
        {% endfor %}
        <div class="summary-total">
            <span>–ò—Ç–æ–≥–æ:</span>
            <span id="total">{{ total }} ‚ÇΩ</span>
        </div>
        <a href="{% url 'checkout' %}" class="btn btn-primary" style="width:100%;justify-content:center;margin-top:1.5rem;font-size:1rem;padding:0.9rem;">
            –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </a>
        <a href="{% url 'catalog' %}" class="btn btn-outline" style="width:100%;justify-content:center;margin-top:0.8rem;">
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
        </a>
    </div>
</div>
{% else %}
<div class="empty-cart">
    <span style="font-size:5rem;display:block;margin-bottom:1rem;">üõí</span>
    <h2>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
    <p>–ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ ‚Äî —Ç–∞–º —Ç–∞–∫ –º–Ω–æ–≥–æ –∫—Ä–∞—Å–∏–≤–æ–≥–æ!</p>
    <a href="{% url 'catalog' %}" class="btn btn-primary" style="margin-top:1.5rem;font-size:1rem;">
         –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
    </a>
</div>
{% endif %}

</div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const prices = { {% for item in items %}{{ item.flower.pk }}: {{ item.flower.price }},{% endfor %} };
const qtys = { {% for item in items %}{{ item.flower.pk }}: {{ item.qty }},{% endfor %} };

function updateQty(pk, delta) {
    const newQty = (qtys[pk] || 1) + delta;
    if (newQty < 1) { removeItem(pk); return; }
    fetch(`/cart/update/${pk}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type':'application/json'},
        body: JSON.stringify({quantity: newQty})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            qtys[pk] = newQty;
            document.getElementById(`qty-${pk}`).textContent = newQty;
            const sub = (prices[pk] * newQty).toFixed(2);
            document.getElementById(`sub-${pk}`).textContent = sub + ' ‚ÇΩ';
            document.getElementById('total').textContent = d.total + ' ‚ÇΩ';
            const badge = document.querySelector('.nav-cart .badge');
            if (badge) badge.textContent = d.count;
        }
    });
}

function removeItem(pk) {
    fetch(`/cart/remove/${pk}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')}
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            document.getElementById(`cart-item-${pk}`).style.transition = 'opacity 0.3s';
            document.getElementById(`cart-item-${pk}`).style.opacity = '0';
            setTimeout(() => { document.getElementById(`cart-item-${pk}`).remove(); }, 300);
            const badge = document.querySelector('.nav-cart .badge');
            if (badge) { if (d.count > 0) badge.textContent = d.count; else badge.remove(); }
        }
    });
}
</script>
{% endblock %}
